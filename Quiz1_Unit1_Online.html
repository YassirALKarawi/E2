<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Quiz 1 â€” Unit 1: Getting to Know You</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f5f5f0;--card:#ffffff;--border:#ddd;
  --text1:#1a1a1a;--text2:#444;--text3:#777;
  --accent:#1a3a5c;--accent2:#2a5a8c;--accent-light:#e8f0f8;
  --correct:#2e7d32;--correct-bg:#e8f5e9;
  --wrong:#c62828;--wrong-bg:#ffebee;
  --section-bg:#f0f4f8;--hover:#f8f8f5;
  --radius:8px;
}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text1);line-height:1.5;min-height:100vh}
.container{max-width:700px;margin:0 auto;padding:16px}

/* Header */
.header{background:var(--accent);color:#fff;padding:20px 24px;border-radius:var(--radius);margin-bottom:16px;text-align:center}
.header h1{font-size:1.3em;margin-bottom:4px;letter-spacing:0.5px}
.header p{font-size:0.82em;opacity:0.85}
.header .dept{font-size:0.75em;opacity:0.7;margin-top:2px}

/* Login */
.login-box{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px}
.login-box h2{font-size:1.1em;color:var(--accent);margin-bottom:16px;text-align:center}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:0.85em;font-weight:600;color:var(--text2);margin-bottom:4px}
.form-group input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.95em;transition:border 0.2s}
.form-group input:focus{outline:none;border-color:var(--accent2)}
.info-box{background:var(--accent-light);border:1px solid #c8d8e8;border-radius:6px;padding:12px;font-size:0.82em;color:var(--text2);margin-bottom:16px;line-height:1.6}
.info-box b{color:var(--accent)}

/* Buttons */
.btn{display:inline-block;padding:11px 28px;border:none;border-radius:6px;font-size:0.95em;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn-primary{background:var(--accent);color:#fff;width:100%}
.btn-primary:hover{background:var(--accent2)}
.btn-primary:disabled{background:#aaa;cursor:not-allowed}
.btn-submit{background:var(--correct);color:#fff;width:100%;padding:13px;font-size:1em;margin-top:12px}
.btn-submit:hover{background:#256b28}
.btn-submit:disabled{background:#aaa;cursor:not-allowed}

/* Timer bar */
.timer-bar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.timer-bar .time{font-size:1.1em;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums}
.timer-bar .time.warning{color:var(--wrong)}
.timer-bar .progress-wrap{flex:1;margin:0 16px;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden}
.timer-bar .progress-fill{height:100%;background:var(--accent);border-radius:3px;transition:width 0.3s}
.timer-bar .count{font-size:0.85em;color:var(--text3)}

/* Sections */
.section-bar{background:var(--section-bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px 14px;margin:14px 0 8px;display:flex;justify-content:space-between;align-items:center}
.section-bar .title{font-weight:700;font-size:0.92em;color:var(--accent)}
.section-bar .marks{font-size:0.8em;color:var(--text3)}

/* Reading passage */
.passage-box{background:#fafcff;border:1px solid #ccd8e8;border-radius:6px;padding:14px;margin:8px 0;font-size:0.85em;color:var(--text2);line-height:1.7}

/* Questions */
.q-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;transition:border 0.2s}
.q-card.answered{border-color:#bbb}
.q-card .q-head{display:flex;gap:8px;margin-bottom:8px}
.q-card .q-num{background:var(--accent);color:#fff;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.78em;font-weight:700;flex-shrink:0}
.q-card .q-text{font-size:0.9em;font-weight:600;color:var(--text1);padding-top:2px}
.options{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
@media(max-width:500px){.options{grid-template-columns:1fr}}
.option{border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:0.85em;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:8px}
.option:hover{background:var(--hover);border-color:#bbb}
.option.selected{background:var(--accent-light);border-color:var(--accent);font-weight:600}
.option .letter{background:#eee;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75em;font-weight:700;flex-shrink:0}
.option.selected .letter{background:var(--accent);color:#fff}
.option.correct-show{background:var(--correct-bg);border-color:var(--correct)}
.option.correct-show .letter{background:var(--correct);color:#fff}
.option.wrong-show{background:var(--wrong-bg);border-color:var(--wrong)}
.option.wrong-show .letter{background:var(--wrong);color:#fff}
.option.disabled{pointer-events:none;opacity:0.7}

/* Results */
.results-box{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:28px;text-align:center;margin-top:16px}
.results-box .score-circle{width:120px;height:120px;border-radius:50%;border:5px solid var(--accent);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:16px auto}
.results-box .score-num{font-size:2.2em;font-weight:800;color:var(--accent)}
.results-box .score-of{font-size:0.8em;color:var(--text3)}
.results-box .student-name{font-size:1.1em;font-weight:700;margin-bottom:4px}
.results-box .breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:16px 0;text-align:center}
.results-box .b-item{background:var(--section-bg);border-radius:6px;padding:10px}
.results-box .b-item .b-label{font-size:0.75em;color:var(--text3)}
.results-box .b-item .b-val{font-size:1.2em;font-weight:700;color:var(--accent)}
.sending-status{font-size:0.85em;color:var(--text3);margin-top:12px}

.hidden{display:none!important}

/* Warning overlay */
.warning-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:999;display:flex;align-items:center;justify-content:center}
.warning-overlay .box{background:#fff;border-radius:12px;padding:28px;max-width:360px;text-align:center}
.warning-overlay .box h3{color:var(--wrong);margin-bottom:8px}
.warning-overlay .box p{font-size:0.9em;color:var(--text2);margin-bottom:16px}
</style>
</head>
<body>

<div class="container">
  <!-- HEADER -->
  <div class="header">
    <h1>Quiz 1 â€” Unit 1: Getting to Know You</h1>
    <p>English Language 2 &nbsp;|&nbsp; Dr. Yassir AL-Ameen</p>
    <div class="dept">University of Diyala â€” Communications Engineering Dept.</div>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-box">
    <h2>Student Information</h2>
    <div class="form-group">
      <label>Full Name (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ)</label>
      <input type="text" id="studentName" placeholder="Enter your full name" autocomplete="off">
    </div>
    <div class="form-group">
      <label>Phone Number (Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ)</label>
      <input type="tel" id="studentPhone" placeholder="07XXXXXXXXX" autocomplete="off">
    </div>
    <div class="info-box">
      <b>Quiz Details:</b><br>
      â€¢ <b>25</b> multiple-choice questions<br>
      â€¢ Sections: Grammar, Question Words, Vocabulary, Reading, Social Expressions<br>
      â€¢ Time: <b>20 minutes</b><br>
      â€¢ Each question = <b>1 mark</b> (Total: 25)<br>
      â€¢ âš ï¸ Do not leave or switch tabs during the quiz
    </div>
    <button class="btn btn-primary" onclick="startQuiz()">Start Quiz â†’</button>
  </div>

  <!-- TIMER BAR -->
  <div id="timerBar" class="timer-bar hidden">
    <div class="time" id="timerDisplay">20:00</div>
    <div class="progress-wrap"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="count" id="qCount">0 / 25</div>
  </div>

  <!-- QUIZ CONTENT -->
  <div id="quizContent" class="hidden"></div>

  <!-- SUBMIT -->
  <div id="submitArea" class="hidden">
    <button class="btn btn-submit" id="submitBtn" onclick="submitQuiz()">Submit Quiz âœ“</button>
  </div>

  <!-- RESULTS -->
  <div id="resultsArea" class="hidden"></div>
</div>

<!-- WARNING OVERLAY -->
<div id="warningOverlay" class="warning-overlay hidden">
  <div class="box">
    <h3>âš ï¸ Warning!</h3>
    <p id="warningMsg">Do not leave the quiz page!</p>
    <button class="btn btn-primary" onclick="dismissWarning()" style="background:var(--wrong)">I Understand</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbxTWVnMkyd1J_ffvrbFbu6DJ5o_C4tDGa7KGi98GaaUazdlwkfwKDSr06JkhL-qwqMm1w/exec";
const QUIZ_TIME = 20 * 60; // 20 minutes

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTION BANK â€” Unit 1: Getting to Know You
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const grammarBank = [
  { q: "I __________ from Bologna, a city in the north of Italy.", opts: ["come","comes","coming","am come"], ans: 0 },
  { q: "Hassan __________ Arabic and French fluently.", opts: ["speak","speaks","is speak","speaking"], ans: 1 },
  { q: "I __________ an essay about Don Quixote right now.", opts: ["write","wrote","'m writing","writes"], ans: 2 },
  { q: "He __________ with his parents. (permanent situation)", opts: ["is living","lives","living","live"], ans: 1 },
  { q: "Last year, his brother __________ to work in the United States.", opts: ["goes","is going","went","has gone"], ans: 2 },
  { q: "When __________ school? â€” He left school at 15.", opts: ["did he leave","he left","does he leave","he did leave"], ans: 0 },
  { q: "After I graduate, I __________ as a translator.", opts: ["work","worked","am working","'m going to work"], ans: 3 },
  { q: "Today, Tom __________ jeans and a T-shirt. (right now)", opts: ["wears","is wearing","wear","wore"], ans: 1 },
  { q: "She __________ to school every morning by bus.", opts: ["go","goes","is going","going"], ans: 1 },
  { q: "Do you __________ black coffee?", opts: ["liking","likes","like","liked"], ans: 2 },
  { q: "Last year she __________ on holiday to Florida.", opts: ["goes","went","is going","go"], ans: 1 },
  { q: "Next year, she __________ at university.", opts: ["studies","studied","is going to study","study"], ans: 2 },
];

const questionWordsBank = [
  { q: "__________ were you born? â€” In Morocco.", opts: ["When","Where","Why","How"], ans: 1 },
  { q: "__________ did you start learning English? â€” A year ago.", opts: ["Where","Why","When","How"], ans: 2 },
  { q: "__________ do you have English classes? â€” Three times a week.", opts: ["How much","How many","How long","How often"], ans: 3 },
  { q: "__________ is your best friend? â€” Jack.", opts: ["What","Where","Who","Which"], ans: 2 },
  { q: "__________ are you learning English? â€” Because I need it for my job.", opts: ["When","How","Where","Why"], ans: 3 },
  { q: "__________ did you pay for the ticket? â€” $5.", opts: ["How many","How much","How often","How long"], ans: 1 },
  { q: "__________ one do you prefer, the red or the blue? â€” The blue one.", opts: ["What","Who","Which","Where"], ans: 2 },
  { q: "__________ bag is this? â€” It's mine.", opts: ["Who","What","Which","Whose"], ans: 3 },
];

const vocabBank = [
  { q: '"He <u>quickly</u> finished his homework." â€” The underlined word is:', opts: ["noun","verb","adjective","adverb"], ans: 3 },
  { q: '"It was a <u>beautiful</u> day." â€” The underlined word is:', opts: ["noun","adverb","adjective","verb"], ans: 2 },
  { q: "Which word can be BOTH a noun and a verb?", opts: ["beautiful","quickly","ring","never"], ans: 2 },
  { q: "Which verb-noun combination is correct?", opts: ["send â€” football","play â€” emails","give â€” advice","cook â€” the Internet"], ans: 2 },
  { q: '"She <u>went</u> to the market." â€” The underlined word is:', opts: ["noun","adjective","adverb","verb (past tense)"], ans: 3 },
  { q: "Which word can be BOTH a noun and a verb? (like 'book')", opts: ["hot","never","train","quickly"], ans: 2 },
  { q: "Which combination is correct?", opts: ["become â€” emails","play â€” football","send â€” friends","grow up â€” food"], ans: 1 },
  { q: '"She gave me a <u>kind</u> smile." â€” The underlined word is:', opts: ["noun","adverb","adjective","verb"], ans: 2 },
];

const readingPassage = `We can communicate with other people in many different ways. We can talk and write, and we can send messages with our hands and faces. There is also the phone (including the mobile for chatting and text messaging), the fax, and e-mail. Television, film, painting, and photography can also communicate ideas.

Animals have ways of exchanging information, too. Bees dance and tell other bees where to find food. Elephants make sounds that humans can't hear. Whales communicate by song. Monkeys use their faces to show anger and love. But this is nothing compared to what people can do. We have language â€” about 6,000 languages, in fact. We can write poetry, tell jokes, make promises, explain, persuade, tell the truth, or tell lies.

Communication technologies were very important in the development of all the great ancient societies. Around 2900 BC, paper and hieroglyphics transformed Egyptian life. The ancient Greeks loved the spoken word. They were very good at public speaking, drama, and philosophy. The Romans developed a unique system of government that depended on the Roman alphabet. In the 14th century, the printing press helped develop new ways of thinking across Europe.

Radio and television have had a huge influence on society in the last hundred years. And now we have the Internet, which is infinite. But what is this doing to us? We can give and get a lot of information very quickly. But there is so much information that it is difficult to know what is important and what isn't.`;

const readingBank = [
  { q: "How many languages do people have?", opts: ["About 600","About 6,000","About 60,000","About 6 million"], ans: 1 },
  { q: "Which animal communicates by song?", opts: ["Bees","Elephants","Monkeys","Whales"], ans: 3 },
  { q: "What did the ancient Greeks love?", opts: ["Hieroglyphics","The spoken word","The Roman alphabet","The printing press"], ans: 1 },
  { q: "When did the printing press help develop new ways of thinking?", opts: ["Around 2900 BC","In the 10th century","In the 14th century","In the 20th century"], ans: 2 },
  { q: "What is the problem with information technology today?", opts: ["It is too expensive","There is too much information to know what is important","People cannot use it","It is only available in English"], ans: 1 },
  { q: "Which ancient society used hieroglyphics?", opts: ["The Greeks","The Romans","The Egyptians","The Europeans"], ans: 2 },
  { q: "How do bees communicate?", opts: ["By song","By making sounds","By dancing","By using their faces"], ans: 2 },
  { q: "What do monkeys use to show anger and love?", opts: ["Sounds","Dance","Song","Their faces"], ans: 3 },
];

const socialBank = [
  { q: '"Thank you very much indeed." â€” The best response:', opts: ["Sleep well!","How do you do?","Not at all. Don't mention it.","Same to you!"], ans: 2 },
  { q: '"Have a good weekend!" â€” The best response:', opts: ["Pleased to meet you.","Same to you!","Not at all.","Bless you!"], ans: 1 },
  { q: '"Hello, I\'m Ela Paul." â€” The correct reply:', opts: ["Fine, thanks.","Pleased to meet you, Ela.","See you tomorrow!","Make yourself at home."], ans: 1 },
  { q: '"Good night!" â€” The best response:', opts: ["Good morning!","Fine, thanks.","Sleep well!","How do you do?"], ans: 2 },
  { q: '"How are you?" â€” The best response:', opts: ["Bye!","Pleased to meet you.","Same to you!","Fine, thanks."], ans: 3 },
  { q: 'Someone sneezes. You say:', opts: ["Excuse me!","Bless you!","How do you do?","See you tomorrow!"], ans: 1 },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  name: '', phone: '',
  questions: [], answers: {},
  startTime: null, endTime: null,
  timer: null, timeLeft: QUIZ_TIME,
  violations: 0, quizStarted: false, quizFinished: false,
  sectionCounts: {}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  let a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function pickRandom(bank, count) {
  return shuffle(bank).slice(0, count);
}

function shuffleOptions(q) {
  const indices = q.opts.map((_, i) => i);
  const shuffled = shuffle(indices);
  const newOpts = shuffled.map(i => q.opts[i]);
  const newAns = shuffled.indexOf(q.ans);
  return { ...q, opts: newOpts, ans: newAns };
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildQuestions() {
  const grammar = pickRandom(grammarBank, 8).map(q => ({ ...shuffleOptions(q), section: 'Grammar' }));
  const qwords = pickRandom(questionWordsBank, 5).map(q => ({ ...shuffleOptions(q), section: 'Question Words' }));
  const vocab = pickRandom(vocabBank, 4).map(q => ({ ...shuffleOptions(q), section: 'Vocabulary' }));
  const reading = pickRandom(readingBank, 5).map(q => ({ ...shuffleOptions(q), section: 'Reading' }));
  const social = pickRandom(socialBank, 3).map(q => ({ ...shuffleOptions(q), section: 'Social Expressions' }));

  state.sectionCounts = { Grammar: 8, 'Question Words': 5, Vocabulary: 4, Reading: 5, 'Social Expressions': 3 };
  state.questions = [...grammar, ...qwords, ...vocab, ...reading, ...social];
}

function renderQuiz() {
  const container = document.getElementById('quizContent');
  let html = '';
  let currentSection = '';
  let qNum = 0;
  const letters = ['A','B','C','D'];

  state.questions.forEach((q, idx) => {
    if (q.section !== currentSection) {
      currentSection = q.section;
      const marks = state.sectionCounts[currentSection];
      let sectionNote = '';
      if (currentSection === 'Reading') {
        sectionNote = `<div class="passage-box">${readingPassage.replace(/\n\n/g,'<br><br>')}</div>`;
      }
      html += `<div class="section-bar"><span class="title">${getSectionLabel(currentSection)}</span><span class="marks">${marks} marks</span></div>`;
      if (sectionNote) html += sectionNote;
    }
    qNum++;
    html += `<div class="q-card" id="qcard-${idx}">
      <div class="q-head">
        <div class="q-num">${qNum}</div>
        <div class="q-text">${q.q}</div>
      </div>
      <div class="options">
        ${q.opts.map((opt, j) => `
          <div class="option" id="opt-${idx}-${j}" onclick="selectOption(${idx},${j})">
            <span class="letter">${letters[j]}</span>
            <span>${opt}</span>
          </div>
        `).join('')}
      </div>
    </div>`;
  });

  container.innerHTML = html;
}

function getSectionLabel(s) {
  const labels = {
    'Grammar': 'Section A: Grammar â€” Tenses',
    'Question Words': 'Section B: Question Words',
    'Vocabulary': 'Section C: Vocabulary & Dictionary',
    'Reading': 'Section D: Reading â€” People, the Great Communicators',
    'Social Expressions': 'Section E: Social Expressions'
  };
  return labels[s] || s;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectOption(qIdx, optIdx) {
  if (state.quizFinished) return;
  
  // Deselect previous
  const prev = state.answers[qIdx];
  if (prev !== undefined) {
    document.getElementById(`opt-${qIdx}-${prev}`).classList.remove('selected');
  }
  
  state.answers[qIdx] = optIdx;
  document.getElementById(`opt-${qIdx}-${optIdx}`).classList.add('selected');
  document.getElementById(`qcard-${qIdx}`).classList.add('answered');
  
  updateProgress();
}

function updateProgress() {
  const answered = Object.keys(state.answers).length;
  const total = state.questions.length;
  const pct = (answered / total) * 100;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('qCount').textContent = `${answered} / ${total}`;
  document.getElementById('submitBtn').disabled = false; // allow submit anytime
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer() {
  state.timer = setInterval(() => {
    state.timeLeft--;
    const display = document.getElementById('timerDisplay');
    display.textContent = formatTime(state.timeLeft);
    
    if (state.timeLeft <= 120) display.classList.add('warning');
    
    if (state.timeLeft <= 0) {
      clearInterval(state.timer);
      autoSubmit();
    }
  }, 1000);
}

function autoSubmit() {
  if (!state.quizFinished) {
    state.timeUp = true;
    finishQuiz();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startQuiz() {
  const name = document.getElementById('studentName').value.trim();
  const phone = document.getElementById('studentPhone').value.trim();
  
  if (!name) { alert('Please enter your name / Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'); return; }
  if (!phone || phone.length < 10) { alert('Please enter a valid phone number / Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­'); return; }
  
  state.name = name;
  state.phone = phone;
  state.startTime = new Date();
  state.quizStarted = true;
  state.timeUp = false;
  
  buildQuestions();
  renderQuiz();
  
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('timerBar').classList.remove('hidden');
  document.getElementById('quizContent').classList.remove('hidden');
  document.getElementById('submitArea').classList.remove('hidden');
  
  startTimer();
  updateProgress();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT & FINISH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function submitQuiz() {
  const answered = Object.keys(state.answers).length;
  const total = state.questions.length;
  const unanswered = total - answered;
  
  if (unanswered > 0) {
    if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?\n\nÙ„Ø¯ÙŠÙƒ ${unanswered} Ø³Ø¤Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ø¬Ø§Ø¨Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŸ`)) return;
  }
  finishQuiz();
}

function finishQuiz() {
  if (state.quizFinished) return;
  state.quizFinished = true;
  state.endTime = new Date();
  clearInterval(state.timer);
  
  // Calculate scores
  let totalScore = 0;
  const sectionScores = {};
  
  state.questions.forEach((q, idx) => {
    if (!sectionScores[q.section]) sectionScores[q.section] = { correct: 0, total: 0 };
    sectionScores[q.section].total++;
    
    const chosen = state.answers[idx];
    if (chosen === q.ans) {
      totalScore++;
      sectionScores[q.section].correct++;
    }
  });
  
  // Show correct/wrong
  const letters = ['A','B','C','D'];
  state.questions.forEach((q, idx) => {
    const chosen = state.answers[idx];
    q.opts.forEach((_, j) => {
      const el = document.getElementById(`opt-${idx}-${j}`);
      el.classList.add('disabled');
      if (j === q.ans) el.classList.add('correct-show');
      if (chosen !== undefined && chosen !== q.ans && j === chosen) el.classList.add('wrong-show');
    });
  });
  
  // Hide submit
  document.getElementById('submitArea').classList.add('hidden');
  
  // Time calculation
  const elapsed = Math.round((state.endTime - state.startTime) / 1000);
  const timeFormatted = formatTime(elapsed);
  const percentage = Math.round((totalScore / state.questions.length) * 100);
  
  // Results display
  const resultsArea = document.getElementById('resultsArea');
  resultsArea.classList.remove('hidden');
  resultsArea.innerHTML = `
    <div class="results-box">
      <div class="student-name">${state.name}</div>
      <div style="font-size:0.82em;color:var(--text3)">Time: ${timeFormatted} ${state.timeUp ? '(Time Up!)' : ''} | Violations: ${state.violations}</div>
      <div class="score-circle">
        <span class="score-num">${totalScore}</span>
        <span class="score-of">out of ${state.questions.length}</span>
      </div>
      <div style="font-size:1.1em;font-weight:700;color:var(--accent)">${percentage}%</div>
      <div class="breakdown">
        ${Object.entries(sectionScores).map(([sec, s]) => `
          <div class="b-item">
            <div class="b-label">${sec}</div>
            <div class="b-val">${s.correct}/${s.total}</div>
          </div>
        `).join('')}
      </div>
      <div class="sending-status" id="sendStatus">ğŸ“¤ Sending results...</div>
    </div>
  `;
  
  // Scroll to results
  resultsArea.scrollIntoView({ behavior: 'smooth' });
  
  // Send to Google Sheets
  const payload = {
    timestamp: new Date().toISOString(),
    name: state.name,
    phone: state.phone,
    score: totalScore,
    total: state.questions.length,
    percentage: percentage,
    grammar: `${sectionScores['Grammar']?.correct || 0}/${sectionScores['Grammar']?.total || 0}`,
    question_words: `${sectionScores['Question Words']?.correct || 0}/${sectionScores['Question Words']?.total || 0}`,
    vocabulary: `${sectionScores['Vocabulary']?.correct || 0}/${sectionScores['Vocabulary']?.total || 0}`,
    reading: `${sectionScores['Reading']?.correct || 0}/${sectionScores['Reading']?.total || 0}`,
    social: `${sectionScores['Social Expressions']?.correct || 0}/${sectionScores['Social Expressions']?.total || 0}`,
    time_formatted: timeFormatted,
    violations: state.violations,
    unanswered: state.questions.length - Object.keys(state.answers).length,
    time_up: state.timeUp ? 'Yes' : 'No',
    start_time: state.startTime.toISOString(),
    end_time: state.endTime.toISOString(),
  };
  
  sendToSheets(payload);
}

function sendToSheets(payload) {
  // Method 1: fetch POST
  fetch(GOOGLE_SHEET_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(() => {
    document.getElementById('sendStatus').innerHTML = 'âœ… Results sent successfully!';
  }).catch(() => {
    // Fallback: URL params GET
    const params = new URLSearchParams(payload).toString();
    const img = new Image();
    img.src = GOOGLE_SHEET_URL + '?' + params;
    document.getElementById('sendStatus').innerHTML = 'âœ… Results sent (backup method)';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANTI-CHEAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('visibilitychange', () => {
  if (state.quizStarted && !state.quizFinished && document.hidden) {
    state.violations++;
    showWarning('âš ï¸ Tab switch detected! This is recorded.\nØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©!');
  }
});

window.addEventListener('blur', () => {
  if (state.quizStarted && !state.quizFinished) {
    state.violations++;
  }
});

history.pushState(null, null, location.href);
window.addEventListener('popstate', () => {
  history.pushState(null, null, location.href);
  if (state.quizStarted && !state.quizFinished) {
    state.violations++;
    showWarning('Do not use the back button!\nÙ„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹!');
  }
});

window.addEventListener('beforeunload', (e) => {
  if (state.quizStarted && !state.quizFinished) {
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
});

function showWarning(msg) {
  document.getElementById('warningMsg').textContent = msg;
  document.getElementById('warningOverlay').classList.remove('hidden');
}

function dismissWarning() {
  document.getElementById('warningOverlay').classList.add('hidden');
}
</script>
</body>
</html>
